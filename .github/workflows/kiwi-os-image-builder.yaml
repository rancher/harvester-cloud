name: Build the certified openSUSE Leap 15.6 image for harvester-cloud

on:
  workflow_dispatch:

env:
  IMAGE_NAME: opensuse-leap-15-6-harv-cloud-image.x86_64
  BUILD_DIR: ${{ github.workspace }}/modules/harvester/kiwi-os-image-builder

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      iso-file: ${{ steps.upload.outputs.iso-path }}
      vhd-file: ${{ steps.upload.outputs.vhd-path }}
      qcow2-file: ${{ steps.upload.outputs.qcow2-path }}
      raw-file: ${{ steps.upload.outputs.raw-path }}
    steps:
      - uses: actions/checkout@v3
      - name: Build ISO with KIWI
        run: |
          docker run --rm --privileged --platform linux/amd64 \
            -v "${BUILD_DIR}":/build opensuse/leap:15.6 bash -c "
              zypper addrepo http://download.opensuse.org/repositories/Virtualization:/Appliances:/Builder/openSUSE_Leap_15.6 kiwi &&
              zypper --gpg-auto-import-keys refresh &&
              zypper in -y python311-kiwi git binutils qemu-tools squashfs xorriso dosfstools e2fsprogs &&
              kiwi system build --description /build --set-repo https://download.opensuse.org/distribution/leap/15.6/repo/oss --target-dir /tmp/kiwi-outputs/ &&
              cp /tmp/kiwi-outputs/*.iso /build/${IMAGE_NAME}.iso
            "
      - name: Install qemu-utils and tools
        run: sudo apt update && sudo apt install -y qemu-utils jq bzip2 tar
      - name: Convert ISO to QCOW2
        run: |
          ISO_PATH="${BUILD_DIR}/${IMAGE_NAME}.iso"
          QCOW2_PATH="${BUILD_DIR}/${IMAGE_NAME}.qcow2"
          qemu-img convert -O qcow2 "$ISO_PATH" "$QCOW2_PATH"
      - name: Convert ISO to RAW
        run: |
          ISO_PATH="${BUILD_DIR}/${IMAGE_NAME}.iso"
          RAW_PATH="${BUILD_DIR}/${IMAGE_NAME}.raw"
          qemu-img convert -O raw "$ISO_PATH" "$RAW_PATH"
          MB=$((1024 * 1024))
          SIZE=$(qemu-img info -f raw --output json "$RAW_PATH" | jq -r '.["virtual-size"]')
          ROUNDED_SIZE=$((($SIZE / $MB + 1) * $MB))
          qemu-img resize -f raw "$RAW_PATH" "$ROUNDED_SIZE"
      - name: Convert RAW to VHD
        run: |
          RAW_PATH="${BUILD_DIR}/${IMAGE_NAME}.raw"
          VHD_PATH="${BUILD_DIR}/${IMAGE_NAME}.vhd"
          qemu-img convert -f raw -O vpc -o subformat=fixed,force_size "$RAW_PATH" "$VHD_PATH"
      - name: Prepare QCOW2 for DigitalOcean
        run: |
          QCOW2_PATH="${BUILD_DIR}/${IMAGE_NAME}.qcow2"
          bzip2 -9 "$QCOW2_PATH"
      - name: Prepare RAW for Google Cloud
        run: |
          RAW_PATH="${BUILD_DIR}/${IMAGE_NAME}.raw"
          OUT_DIR="${BUILD_DIR}"
          cp "$RAW_PATH" "${OUT_DIR}/disk.raw"
          tar --format=oldgnu -C "$OUT_DIR" -czf "${OUT_DIR}/${IMAGE_NAME}.raw.tar.gz" disk.raw
      - name: List files before upload
        run: ls -lh "${BUILD_DIR}"
      - name: Upload artifact
        id: upload
        uses: actions/upload-artifact@v6
        with:
          name: harvester-os-image
          path: |
            ${{ env.BUILD_DIR }}/${{ env.IMAGE_NAME }}.iso
            ${{ env.BUILD_DIR }}/${{ env.IMAGE_NAME }}.vhd
            ${{ env.BUILD_DIR }}/${{ env.IMAGE_NAME }}.qcow2.bz2
            ${{ env.BUILD_DIR }}/${{ env.IMAGE_NAME }}.raw.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Download artifact from build
        uses: actions/download-artifact@v5
        with:
          name: harvester-os-image
          path: ./artifact
      - name: Install GitHub CLI
        run: sudo apt update && sudo apt install -y gh
      - name: Create Release
        run: |
          gh release create "build-${GITHUB_RUN_NUMBER}" \
            ./artifact/${{ env.IMAGE_NAME }}.iso \
            ./artifact/${{ env.IMAGE_NAME }}.vhd \
            ./artifact/${{ env.IMAGE_NAME }}.qcow2.bz2 \
            ./artifact/${{ env.IMAGE_NAME }}.raw.tar.gz \
            --title "Certified openSUSE Leap 15.6 image for harvester-cloud - build-${GITHUB_RUN_NUMBER}" \
            --notes "Release automatically generated by GitHub Actions."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
